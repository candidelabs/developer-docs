#!/usr/bin/env node

/**
 * Fix broken markdown links generated by @signalwire/docusaurus-plugin-llms-txt
 *
 * The plugin incorrectly handles Docusaurus links with trailingSlash: true,
 * converting links like /wallet/paymaster/tokens-supported/ to:
 *   https://docs.candide.dev/wallet/paymaster/tokens-supported/.md (broken)
 *
 * This script fixes them to:
 *   https://docs.candide.dev/wallet/paymaster/tokens-supported.md (correct)
 *
 * It also fixes relative path versions like /wallet/paymaster/tokens-supported/.md
 */

const fs = require('fs');
const path = require('path');

const BUILD_DIR = path.join(__dirname, '../build');

function fixMarkdownLinks(filePath) {
  let content = fs.readFileSync(filePath, 'utf8');
  let modified = false;

  // Fix absolute URLs: https://docs.candide.dev/path/.md -> https://docs.candide.dev/path.md
  content = content.replace(/(\bhttps?:\/\/[^\s\)]+)\/(\.md[\)\s])/g, (match, url, ending) => {
    modified = true;
    return url + ending;
  });

  // Fix relative paths: /path/.md -> /path.md
  content = content.replace(/(\[[^\]]+\]\([^)]*)\/(\.md\))/g, (match, beforeSlash, ending) => {
    modified = true;
    return beforeSlash + ending;
  });

  if (modified) {
    fs.writeFileSync(filePath, content, 'utf8');
    const relativePath = path.relative(BUILD_DIR, filePath);
    console.log(`✓ Fixed: ${relativePath}`);
    return 1;
  }

  return 0;
}

function processDirectory(dir) {
  let filesFixed = 0;

  const entries = fs.readdirSync(dir, { withFileTypes: true });

  for (const entry of entries) {
    const fullPath = path.join(dir, entry.name);

    if (entry.isDirectory()) {
      filesFixed += processDirectory(fullPath);
    } else if (entry.isFile() && entry.name.endsWith('.md')) {
      filesFixed += fixMarkdownLinks(fullPath);
    }
  }

  return filesFixed;
}

console.log('Fixing markdown links in build directory...\n');
const filesFixed = processDirectory(BUILD_DIR);
console.log(`\n✅ Fixed broken links in ${filesFixed} file(s)`);
